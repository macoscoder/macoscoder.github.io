<!DOCTYPE html>
<html lang="zh-cn">
<title>互斥锁 | 我的博客</title>
<meta charset="utf-8">
<meta name="generator" content="Hugo 0.60.1" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="canonical" href="http://flyblog.tech/posts/mutex/">
<link rel="alternate" type="application/rss+xml" href="" title="我的博客">
<link rel="stylesheet" href="http://flyblog.tech/css/theme.css">
<link rel="stylesheet" href="http://flyblog.tech/css/classes.css">

<header class="dark">
  <h2><a href="http://flyblog.tech/">我的博客</a></h2>
  <nav>
    
  </nav>
</header>

<article>
  <header>
    <h1>互斥锁</h1>
    <p><time datetime="2011-12-23T13:05:31Z">December 23, 2011</time></p>
  </header>
  <h1 id="heading">互斥锁</h1>
<h2 id="heading1">安装文档</h2>
<p>debian 9上默认没有这个手册，需要自行安装</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo apt install glibc-doc
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ dpkg-query -L glibc-doc | grep pthread
/usr/share/man/man3/pthread_atfork.3.gz
/usr/share/man/man3/pthread_cond_init.3.gz
/usr/share/man/man3/pthread_condattr_init.3.gz
/usr/share/man/man3/pthread_key_create.3.gz
/usr/share/man/man3/pthread_mutex_init.3.gz
/usr/share/man/man3/pthread_mutexattr_init.3.gz
/usr/share/man/man3/pthread_mutexattr_setkind_np.3.gz
/usr/share/man/man3/pthread_once.3.gz
/usr/share/man/man3/pthread_cond_broadcast.3.gz
/usr/share/man/man3/pthread_cond_destroy.3.gz
/usr/share/man/man3/pthread_cond_signal.3.gz
/usr/share/man/man3/pthread_cond_timedwait.3.gz
/usr/share/man/man3/pthread_cond_wait.3.gz
/usr/share/man/man3/pthread_condattr_destroy.3.gz
/usr/share/man/man3/pthread_getspecific.3.gz
/usr/share/man/man3/pthread_key_delete.3.gz
/usr/share/man/man3/pthread_mutex_destroy.3.gz
/usr/share/man/man3/pthread_mutex_lock.3.gz
/usr/share/man/man3/pthread_mutex_trylock.3.gz
/usr/share/man/man3/pthread_mutex_unlock.3.gz
/usr/share/man/man3/pthread_mutexattr_destroy.3.gz
/usr/share/man/man3/pthread_mutexattr_getkind_np.3.gz
/usr/share/man/man3/pthread_mutexattr_gettype.3.gz
/usr/share/man/man3/pthread_mutexattr_settype.3.gz
/usr/share/man/man3/pthread_setspecific.3.gz
</code></pre></div><p>这个包包含了mutex, mutexattr, cond, condattr等手册</p>
<h2 id="heading2">互斥锁相关函数</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;pthread.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
pthread_mutex_t fastmutex <span style="color:#f92672">=</span> PTHREAD_MUTEX_INITIALIZER;
pthread_mutex_t recmutex <span style="color:#f92672">=</span> PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP;
pthread_mutex_t errchkmutex <span style="color:#f92672">=</span> PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP;

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">pthread_mutex_init</span>(pthread_mutex_t <span style="color:#f92672">*</span>mutex, <span style="color:#66d9ef">const</span> pthread_mutexattr_t <span style="color:#f92672">*</span>mutexattr);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">pthread_mutex_destroy</span>(pthread_mutex_t <span style="color:#f92672">*</span>mutex);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">pthread_mutex_lock</span>(pthread_mutex_t <span style="color:#f92672">*</span>mutex);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">pthread_mutex_unlock</span>(pthread_mutex_t <span style="color:#f92672">*</span>mutex);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">pthread_mutex_trylock</span>(pthread_mutex_t <span style="color:#f92672">*</span>mutex);
</code></pre></div><h2 id="heading3">示例</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// mutex.c
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;pthread.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> global;
<span style="color:#66d9ef">static</span> pthread_mutex_t mutex <span style="color:#f92672">=</span> PTHREAD_MUTEX_INITIALIZER;

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">thread_func</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>arg) {
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1000000</span>; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        pthread_mutex_lock(<span style="color:#f92672">&amp;</span>mutex);
        global<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
        pthread_mutex_unlock(<span style="color:#f92672">&amp;</span>mutex);
    }
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    pthread_t tid1, tid2;
    pthread_create(<span style="color:#f92672">&amp;</span>tid1, NULL, thread_func, NULL);
    pthread_create(<span style="color:#f92672">&amp;</span>tid2, NULL, thread_func, NULL);

    pthread_join(tid1, NULL);
    pthread_join(tid2, NULL);

    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">global = %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, global);
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ cc -pthread mutex.c
$ ./a.out
global <span style="color:#f92672">=</span> <span style="color:#ae81ff">2000000</span>
</code></pre></div><h2 id="heading4">初始化一次</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;pthread.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>pthread_once_t once_control <span style="color:#f92672">=</span> PTHREAD_ONCE_INIT;
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">pthread_once</span>(pthread_once_t <span style="color:#f92672">*</span>once_control, <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>init_routine)());
</code></pre></div>
</article>



</html>
