<!DOCTYPE html>
<html lang="zh-cn">
<title>进程终止 | 我的博客</title>
<meta charset="utf-8">
<meta name="generator" content="Hugo 0.60.1" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="canonical" href="http://flyblog.tech/posts/process-termination/">
<link rel="alternate" type="application/rss+xml" href="" title="我的博客">
<link rel="stylesheet" href="http://flyblog.tech/css/theme.css">
<link rel="stylesheet" href="http://flyblog.tech/css/classes.css">

<header class="dark">
  <h2><a href="http://flyblog.tech/">我的博客</a></h2>
  <nav>
    
  </nav>
</header>

<article>
  <header>
    <h1>进程终止</h1>
    <p><time datetime="2011-12-23T13:05:31Z">December 23, 2011</time></p>
  </header>
  <h1 id="heading">进程终止</h1>
<h2 id="heading1">终止方式</h2>
<p>进程终止的两种方式</p>
<ul>
<li>正常终止</li>
<li>非正常终止</li>
</ul>
<h3 id="heading2">正常终止</h3>
<p>系统调用</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;linux/unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">exit_group</span>(<span style="color:#66d9ef">int</span> status);
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">_exit</span>(<span style="color:#66d9ef">int</span> status);
</code></pre></div><p>库函数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">exit</span>(<span style="color:#66d9ef">int</span> status);
</code></pre></div><p><code>exit</code>和<code>_exit</code>的区别是<code>exit</code>会额外执行以下动作:</p>
<ul>
<li>Call exit handlers, in reverse order of their registration</li>
<li>Flush stdio stream</li>
</ul>
<h3 id="heading3">非正常终止</h3>
<p>进程收到信号导致的终止称为非正常终止</p>
<p>硬件产生的信号</p>
<p><code>SIGILL</code>, <code>SIGBUS</code>, <code>SIGFPE</code>, <code>SIGSEGV</code></p>
<p>终端驱动产生的信号</p>
<p><code>SIGHUP</code>, <code>SIGINT</code>, <code>SIGQUIT</code></p>
<p>系统调用</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;signal.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">kill</span>(pid_t pid, <span style="color:#66d9ef">int</span> sig);
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">tkill</span>(<span style="color:#66d9ef">int</span> tid, <span style="color:#66d9ef">int</span> sig);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">tgkill</span>(<span style="color:#66d9ef">int</span> tgid, <span style="color:#66d9ef">int</span> tid, <span style="color:#66d9ef">int</span> sig);
</code></pre></div><p>库函数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;signal.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;pthread.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">pthread_kill</span>(pthread_t <span style="color:#66d9ef">thread</span>, <span style="color:#66d9ef">int</span> sig);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">pthread_sigqueue</span>(pthread_t <span style="color:#66d9ef">thread</span>, <span style="color:#66d9ef">int</span> sig, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">union</span> sigval value);
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;signal.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">raise</span>(<span style="color:#66d9ef">int</span> sig);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">killpg</span>(<span style="color:#66d9ef">int</span> pgrp, <span style="color:#66d9ef">int</span> sig);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sigqueue</span>(pid_t pid, <span style="color:#66d9ef">int</span> sig, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">union</span> sigval value);
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">abort</span>(); <span style="color:#75715e">// SIGABRT
</span></code></pre></div><h3 id="termination-status">终止状态(termination status)</h3>
<p>进程终止时会产生一个终止状态值[0-255]，这个值会被父进程收集到<br>
在<code>shell</code>中可以通过<code>shell</code>变量<code>$?</code>来获取<code>shell</code>的子进程的终止状态</p>
<p>正常终止的终止状态称为退出状态(由<code>_exit</code>等函数的参数指定，0表示成功)<br>
非正常终止的终止状态为终止该进程的信号值</p>
<h4 id="exit-status">退出状态(exit status)</h4>
<p>尽管<code>_exit</code>的<code>status</code>参数类型是<code>int</code>，但是只有低8位有效(status &amp; oxff)，范围为[0-255]</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// exit.c
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    exit(<span style="color:#ae81ff">256</span>); <span style="color:#75715e">// 256 = 0x100
</span><span style="color:#75715e"></span>}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ cc exit.c
$ ./a.out
$ echo $?
<span style="color:#ae81ff">0</span>
</code></pre></div><h4 id="heading4">非正常终止的终止状态</h4>
<p>前面提到: 非正常终止的终止状态为终止该进程的信号值<br>
由于linux的标准信号的取值范围是[1-31]，实时信号的取值范围是[SIGRTMIN-SIGRTMAX]</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ bash -c <span style="color:#e6db74">&#39;kill -l&#39;</span>
 1<span style="color:#f92672">)</span> SIGHUP       2<span style="color:#f92672">)</span> SIGINT       3<span style="color:#f92672">)</span> SIGQUIT      4<span style="color:#f92672">)</span> SIGILL       5<span style="color:#f92672">)</span> SIGTRAP
 6<span style="color:#f92672">)</span> SIGABRT      7<span style="color:#f92672">)</span> SIGBUS       8<span style="color:#f92672">)</span> SIGFPE       9<span style="color:#f92672">)</span> SIGKILL     10<span style="color:#f92672">)</span> SIGUSR1
11<span style="color:#f92672">)</span> SIGSEGV     12<span style="color:#f92672">)</span> SIGUSR2     13<span style="color:#f92672">)</span> SIGPIPE     14<span style="color:#f92672">)</span> SIGALRM     15<span style="color:#f92672">)</span> SIGTERM
16<span style="color:#f92672">)</span> SIGSTKFLT   17<span style="color:#f92672">)</span> SIGCHLD     18<span style="color:#f92672">)</span> SIGCONT     19<span style="color:#f92672">)</span> SIGSTOP     20<span style="color:#f92672">)</span> SIGTSTP
21<span style="color:#f92672">)</span> SIGTTIN     22<span style="color:#f92672">)</span> SIGTTOU     23<span style="color:#f92672">)</span> SIGURG      24<span style="color:#f92672">)</span> SIGXCPU     25<span style="color:#f92672">)</span> SIGXFSZ
26<span style="color:#f92672">)</span> SIGVTALRM   27<span style="color:#f92672">)</span> SIGPROF     28<span style="color:#f92672">)</span> SIGWINCH    29<span style="color:#f92672">)</span> SIGIO       30<span style="color:#f92672">)</span> SIGPWR
31<span style="color:#f92672">)</span> SIGSYS      34<span style="color:#f92672">)</span> SIGRTMIN    35<span style="color:#f92672">)</span> SIGRTMIN+1  36<span style="color:#f92672">)</span> SIGRTMIN+2  37<span style="color:#f92672">)</span> SIGRTMIN+3
38<span style="color:#f92672">)</span> SIGRTMIN+4  39<span style="color:#f92672">)</span> SIGRTMIN+5  40<span style="color:#f92672">)</span> SIGRTMIN+6  41<span style="color:#f92672">)</span> SIGRTMIN+7  42<span style="color:#f92672">)</span> SIGRTMIN+8
43<span style="color:#f92672">)</span> SIGRTMIN+9  44<span style="color:#f92672">)</span> SIGRTMIN+10 45<span style="color:#f92672">)</span> SIGRTMIN+11 46<span style="color:#f92672">)</span> SIGRTMIN+12 47<span style="color:#f92672">)</span> SIGRTMIN+13
48<span style="color:#f92672">)</span> SIGRTMIN+14 49<span style="color:#f92672">)</span> SIGRTMIN+15 50<span style="color:#f92672">)</span> SIGRTMAX-14 51<span style="color:#f92672">)</span> SIGRTMAX-13 52<span style="color:#f92672">)</span> SIGRTMAX-12
53<span style="color:#f92672">)</span> SIGRTMAX-11 54<span style="color:#f92672">)</span> SIGRTMAX-10 55<span style="color:#f92672">)</span> SIGRTMAX-9  56<span style="color:#f92672">)</span> SIGRTMAX-8  57<span style="color:#f92672">)</span> SIGRTMAX-7
58<span style="color:#f92672">)</span> SIGRTMAX-6  59<span style="color:#f92672">)</span> SIGRTMAX-5  60<span style="color:#f92672">)</span> SIGRTMAX-4  61<span style="color:#f92672">)</span> SIGRTMAX-3  62<span style="color:#f92672">)</span> SIGRTMAX-2
63<span style="color:#f92672">)</span> SIGRTMAX-1  64<span style="color:#f92672">)</span> SIGRTMAX
</code></pre></div><p>我们假设<code>shell</code>变量<code>$?</code>的值为2，那么我们无法区分是正常终止(<code>exit(2)</code>)，还是非正常终止(^C, send <code>SIGINT</code>)<br>
<code>shell</code>的办法是，如果进程是被信号终止的，那么设置<code>$?</code>的值为<strong>128+signo</strong></p>
<p>另外</p>
<p><code>shell</code>使用<code>126</code>表示命令不能执行，使用<code>127</code>表示命令找不到<br>
<code>exit</code>使用<code>128</code>表示参数无效</p>
<p>基于这个原因，进程正常终止时我们可以使用的<code>exit status</code>范围缩小为**[0-125]**</p>
<p>示例:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// pause.c
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    pause();
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ cc pause.c
$ ./a.out
^C           <span style="color:#75715e"># send SIGINT (2)</span>
$ echo $?
<span style="color:#ae81ff">130</span>          <span style="color:#75715e"># 128 + 2</span>
</code></pre></div><p><code>shell</code>是如何区分子进程是正常终止还是非正常终止的？答案是通过系统调用<code>wait</code>的结果参数<strong>wait status</strong>，具体参考<code>wait(2)</code>手册</p>

</article>



</html>
